{% extends 'base.html' %}
{% block content %}
    <h1>Сброс пароля</h1><br>
    <form action="{{ url_for('admin.admin_panel_reset_password') }}" method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.list_user.label }}
            <input id="list_user" name="list_user" class="form-control select2" placeholder="Введите ФИО родителя">
        </div>
        <ul class="error">
            {% for error in form.list_user.errors %}
            	<h3>{{ error }}</h3>
            {% endfor %}
        </ul>
        <br>
        <div class="form-group">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
    {% for category, message in get_flashed_messages(with_categories=true) %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.select2').select2({
                ajax: {
                    url: '{{ url_for("admin.admin_panel_search_parents") }}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {q: params.term || ''};
                    },
                    processResults: function (data) {
                        console.log('AJAX response:', data);
                        return {results: data.results};
                    },
                    cache: true
                },
                placeholder: 'Введите ФИО родителя',
                minimumInputLength: 0,
                allowClear: true,
                width: '100%',
                templateSelection: function (data, container) {
                    return data.text || data.id;
                },
                templateResult: function (data) {
                    return data.text;
                }
            });

            // Обновляем выбранный элемент
            $('.select2').on('select2:select', function (e) {
                var selectedId = e.params.data.id;
                var selectedText = e.params.data.text;
                // Устанавливаем value для отправки
                $(this).val(selectedId).trigger('change');
                // Обновляем отображаемый текст в Select2
                var $element = $(this);
                $element.data('selected-text', selectedText); // Сохраняем текст
                $element.trigger('change.select2'); // Обновляем интерфейс
            });

            // Переопределяем templateSelection для использования сохранённого текста
            $('.select2').on('change.select2', function () {
                var selectedText = $(this).data('selected-text') || 'Введите ФИО родителя';
                $('.select2-selection__rendered').text(selectedText);
            });

            // Очистка поля
            $('.select2').on('select2:unselect', function (e) {
                $(this).val('').data('selected-text', '').trigger('change.select2');
            });
        });
    </script>
{% endblock %}